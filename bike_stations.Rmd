---
title: "Servicio de bicis en NYC"
output: html_notebook
---

Veamos las ubicaciones de las estaciones en un mapa de la ciudad.
# Mapa Stations
```{r}
library(leaflet)
library(magrittr)
stations <- readr::read_csv("dat/stations.csv")

colnames(stations)
colnames(stations) <- c("X1","station.id","station.name","latitude","longitude")
names(providers)
leaflet(options = leafletOptions(minZoom = 0, maxZoom = 18))
m <- leaflet(stations) %>% addTiles() %>% addProviderTiles(providers$MtbMap) %>%
  addProviderTiles(providers$Stamen.TonerLines,
    options = providerTileOptions(opacity = 0.35)) %>%
  addProviderTiles(providers$Stamen.TonerLabels) 
m %>% addCircles(color = "red",radius=5, opacity = T ) %>% addMarkers(popup = ~htmltools::htmlEscape(station.name)) 

```

Usuarios por edades y género.
# Análisis de usuarios
```{r}
rutas <- readr::read_csv("dat/bike_nyc_1_6_2019.csv")
colnames(rutas)

usuarios <- rutas %>% dplyr::select(birth.year,gender) %>% 
  dplyr::mutate(age = lubridate::year(Sys.Date())-birth.year) %>% 
  dplyr::group_by(age,gender) %>% 
  dplyr::mutate(contador = n()) %>% 
  dplyr::group_by(age,gender,contador) %>% 
  dplyr::summarise()

usuarios %>% ggplot2::ggplot(ggplot2::aes(x = age, y = contador,fill=gender))+
      ggplot2::geom_col()


```

Los de género "unknown" son pocos y además hay un valor absurdo para la edad de 51 años.
Eliminamos los "unknown" y volvemos a sacar la gráfica.

```{r}
usuarios %>% dplyr::filter(gender!="unknown") %>% 
  ggplot2::ggplot(ggplot2::aes(x = age, y = contador,fill=gender))+
  ggplot2::geom_col()
```

Se ve que hay un uso del servicio de bicis mucho mayor por parte de hombres que de mujeres.
La franja de edad de mayor uso está entre los 31 y los 34 años.

Vamos a ver sólo las mujeres.

```{r}
usuarios %>% dplyr::filter(gender=="female") %>% 
  ggplot2::ggplot(ggplot2::aes(x = age, y = contador))+
  ggplot2::geom_col()+
  ggplot2::theme_bw()
  
```

Y los hombres...

```{r}
usuarios %>% dplyr::filter(gender=="male") %>% 
  ggplot2::ggplot(ggplot2::aes(x = age, y = contador))+
  ggplot2::geom_col()
```

Veamos la distribución que sigue la duración de los viajes.

```{r}
rutas %>% dplyr::select(tripduration) %>% 
  ggplot2::ggplot(ggplot2::aes(x=tripduration))+
  ggplot2::geom_density()

```

Veamos com se distribuye la duración media de los viajes.
```{r}
resumen_rutas <- rutas %>% tidyr::unite(ruta, start.station.id,end.station.id,sep="-") %>% 
  dplyr::group_by(ruta) %>% 
  dplyr::summarise(contador = dplyr::n(),
                   avgTrip = mean(tripduration)) %>%
  dplyr::arrange(desc(avgTrip)) %>% 
  dplyr::ungroup()

resumen_rutas %>% dplyr::select(avgTrip) %>% 
  ggplot2::ggplot(ggplot2::aes(x=avgTrip))+
  ggplot2::geom_density()
  
summary(resumen_rutas$avgTrip) 
```
```{r}
stations_geo <- stations %>% 
  tidyr::unite(lat_long,latitude,longitude,sep="+")


rutas_geo <- rutas %>% 
  dplyr::full_join(stations_geo,by=c("start.station.id"="station.id")) %>% 
  dplyr::rename(origin_lat_long=lat_long) %>% 
  dplyr::full_join(stations_geo,by=c("end.station.id"="station.id")) %>% 
  dplyr::rename(end_lat_long=lat_long,station.name.ori=station.name.x,station.name.end=station.name.y) %>% 
  dplyr::select(-c(10,13)) %>% 
  tidyr::unite(ruta, start.station.id,end.station.id,sep="-")

  
results <- gmapsdistance::gmapsdistance(rutas_geo$origin_lat_long[1],rutas_geo$end_lat_long[1],mode="bicycling")



```

